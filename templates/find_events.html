<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find Events - Court Connect</title>
    <script src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}&libraries=places"></script>
    
    <style>
        #map {
            height: 500px; /* Set the height of the map */
            width: 100%;
        }
        /* Additional styles for the info window */
        .event-details {
            display: none;
            position: absolute;
            background-color: white;
            padding: 10px;
            border: 1px solid #ccc;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <h1>Find Events Near You</h1>

    <!-- Hidden input fields for user location -->
    <input type="hidden" id="user_lat" value="{{ user_lat }}">
    <input type="hidden" id="user_long" value="{{ user_long }}">

    <!-- Map Container -->
    <div id="map"></div>
    <div class="event-details" id="event-details"></div>

    <script>
        let map;
    
        function initMap() {
            const userLocation = { 
                lat: parseFloat(document.getElementById('user_lat').value), 
                lng: parseFloat(document.getElementById('user_long').value) 
            };

            // Create a map centered at the user's location
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 12,
                center: userLocation,
            });
    
            // Fetch events and place markers
            fetch('/api/events')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(events => {
                    events.forEach(event => {
                        const coordinates = { lat: parseFloat(event.latitude), lng: parseFloat(event.longitude) };
                        const marker = new google.maps.Marker({
                            position: coordinates,
                            map: map,
                            title: event.title,
                        });

                        // Add click event to marker
                        marker.addListener('click', () => {
                            showEventDetails(event);
                        });
                    });
                })
                .catch(error => {
                    console.error('Error fetching events:', error);
                });
        }

        function showEventDetails(event) {
            const detailsDiv = document.getElementById('event-details');
            detailsDiv.innerHTML = `
                <strong>${event.title}</strong><br>
                <p>${event.description}</p>
                <p><strong>Date:</strong> ${event.date}</p>
                <p><strong>Location:</strong> ${event.venue}</p>
                <button onclick="signupEvent(${event.id})">Sign Up</button>
            `;
            detailsDiv.style.display = 'block';
            detailsDiv.style.left = `${event.clientX}px`; // Adjust position as needed
            detailsDiv.style.top = `${event.clientY}px`; // Adjust position as needed
        }

        function signupEvent(eventId) {
            // Implement your signup logic here, possibly sending a request to your backend
            alert(`Signed up for event ID: ${eventId}`);
        }

        function getCoordinates(venue) {
            const apiKey = '{{ api_key }}'; // Replace with your Google Maps API Key
            const geocodeUrl = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(venue)}&key=${apiKey}`;

            return fetch(geocodeUrl)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'OK') {
                        const location = data.results[0].geometry.location;
                        return { lat: location.lat, lng: location.lng };
                    } else {
                        console.error('Geocoding failed:', data.status);
                        return null;
                    }
                })
                .catch(error => {
                    console.error('Error fetching coordinates:', error);
                    return null;
                });
        }
        window.onload = initMap;
    </script>
</body>
</html>